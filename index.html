<!DOCTYPE HTML>
<!--
    Warning: I'm really bad at coding. Side effects of viewing this document may include depression, insomina, eye strain, and sudden outbursts of laughter. Continue viewing source at your own risk.


	Copyright (c) 2019 David Swanlund
	Permission is hereby granted, free of charge, to any person obtaining a copy of this software and associated documentation files (the "Software"), to deal in the Software without restriction, including without limitation the rights to use, copy, modify, merge, publish, distribute, sublicense, and/or sell copies of the Software, and to permit persons to whom the Software is furnished to do so, subject to the following conditions:
	The above copyright notice and this permission notice shall be included in all copies or substantial portions of the Software.
	THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE SOFTWARE.
-->
<html>
	<head>
		<title>MaskMy.XYZ | An Easy-To-Use Geographic Masking Tool</title>
		<description>MaskMy.XYZ simplifies the process of geographic masking and spatial privacy protection</description>
		<meta charset="utf-8" />
		<meta name="author" content="David Swanlund">
		<meta name="keywords" content="GIS, geomasking, privacy, geoprivacy, geographic masking, publication, science">
		<meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no" />
		<link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
		<link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
		<link rel="stylesheet" href="assets/css/main.css" />
		<!-- <link rel="stylesheet" href="assets/css/ol.css" /> -->
		<link rel="stylesheet" href="assets/css/gifplayer.css" />
		<link rel="stylesheet" href="assets/css/font-awesome.min.css"/>
		<!--[if lte IE 9]><link rel="stylesheet" href="assets/css/ie9.css" /><![endif]-->
		<script src="assets/js/jquery.min.js"></script>
		<script src="assets/js/skel.min.js"></script>
		<script src="assets/js/util.js"></script>
		<script src="assets/js/main.js"></script>
		<script src="assets/js/turf.min.js"></script>
		<script src="assets/js/shpwrite.js"></script>
		<script src="assets/js/jquery.min.js"></script>
		<!-- <script src="assets/js/ol.js"></script> -->
		<script src="assets/js/shp.min.js"></script>
		<script src="assets/js/jszip.min.js"></script>
		<script src="assets/js/FileSaver.js"></script>
		<script src="assets/js/xyz.js"></script>
		<script src="assets/js/proj4.js"></script>
		<script src="assets/js/jquery.gifplayer.js"></script>
		<noscript><link rel="stylesheet" href="assets/css/noscript.css" /></noscript>

		<link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/openlayers/openlayers.github.io@main/dist/en/v7.1.0/ol/ol.css" /> 

  		<script src="https://unpkg.com/d3-fetch@2.0.0"></script>
  		<script src="https://cdn.jsdelivr.net/gh/openlayers/openlayers.github.io@main/dist/en/v7.1.0/ol/dist/ol.js"></script> 
  		<script src="https://unpkg.com/h3-js@3.7.0"></script>

		<!-- Matomo -->
		<script>
			var _paq = window._paq = window._paq || [];
			/* tracker methods like "setCustomDimension" should be called before "trackPageView" */
			_paq.push(['trackPageView']);
			_paq.push(['enableLinkTracking']);
			(function() {
			var u="//data.swanlund.space/";
			_paq.push(['setTrackerUrl', u+'matomo.php']);
			_paq.push(['setSiteId', '2']);
			var d=document, g=d.createElement('script'), s=d.getElementsByTagName('script')[0];
			g.async=true; g.src=u+'matomo.js'; s.parentNode.insertBefore(g,s);
			})();
		</script>
		<noscript><p><img src="//data.swanlund.space/matomo.php?idsite=2&amp;rec=1" style="border:0;" alt="" /></p></noscript>
		<!-- End Matomo Code -->


		<script>
			function displayMap(){
				var x = document.getElementById("mapContainer");
				if (x.style.display === "none") {
					x.style.display = "block";
					map.updateSize();
				} else {
					x.style.display = "none";
				}
			}
    	</script>

		 <style>
			body {
			padding: 15px;
			}

			@media (max-width: 800px) {
			#container {
				height: 650px;
				grid-template-columns: none !important;
				grid-template-rows: auto 1fr;
			}

			#mapContainer {
				height: auto !important;
			}
			}

			#container {
			display: grid;
			grid-template-columns: 370px 1fr;
			}

			#mapContainer {
			height: 600px;
			}

			#controlContainer {
			margin-top: 10px;
			display: grid;
			grid-column-gap: 10px;
			align-self: center;
			}

			#controlContainer label {
			grid-column: 1 / span 1;
			text-align: end;
			}

			#controlContainer input {
			grid-column: 2 / span 1;
			width: 150px;
			}
		</style>	


	</head>
	<body>

		<!-- Wrapper -->
		<div id="wrapper">

			<!-- Header -->
			<header id="header">
				<div class="logo">
					<span class="icon fa-map-marker"></span>
				</div>
				<div class="content">
					<div class="inner">
						<img src='images/logo.png' alt='MaskMy.XYZ' class="logo-image">
						<p>MaskMy.XYZ is a tool that simplifies the process of geographic masking. Everything runs client-side in your browser, meaning there's nothing to install, data never leaves your computer, and as a result nobody except you ever sees your confidential files. It is a safe and secure way to anonymize spatial data without getting your hands dirty in GIS.</p>
					</div>
				</div>
				<nav>
					<ul>
						<li><a href="#about">What is MaskMy.XYZ</a></li>
						<li><a href="#maskingguide">Masking Guide</a></li>
						<li><a href="#dm" style="color: #a00808; font-weight:600;">Masking Tool</a></li>
						<li><a href="#disclaimer">Disclaimer</a></li>
					</ul>
				</nav>
			</header>

			<!-- Main -->
			<div id="main">

				<!-- About -->
				

				<!-- Guided Setup -->
				

				<!-- Donut Masking -->
				<article id="dm">

					<div style="text-align: center; margin: 0 auto;"><img src="images/logo.png" class="logo-image"></div>

					<p>

						<strong></strong>

					<div>
						<span>Load the data you want to mask: </span><span class="icon fa-info-circle tooltip"><span class="tooltiptext">Load your sensitive data here as a zipped shapefile. For more info on how to load data, including an instructional video, check out the <a style="color: #a00808;" href="#maskingguide">masking guide</a>. </span></span><br>
						<input type="file" id="sensitiveInput" accept=".zip">
					</div><br>

					<div>
						<span>(Optional) Load boundary polygons to contain points: </span><span class="icon fa-info-circle tooltip"><span class="tooltiptext">Optional, but if loaded, boundary files allow you to keep masked points within a given area, such as a census unit. For more info, check out the <a style="color: #a00808;" href="#maskingguide">masking guide</a>. Must be loaded as a zipped shapefile.</span></span><br>
						<input type="file" id="boundaryInput" accept=".zip">
					</div><br>

					<div>
						<span><strong>Distance</strong>: set the minimum and maximum distance in meters that any given point will move: </span> <span class="icon fa-info-circle tooltip"><span class="tooltiptext">Masking distances must be chosen carefully. For guidance on selecting a distance, check out the <a style="color: #a00808;" href="#maskingguide">masking guide</a></span></span>
						<br>
						<div class="slideContainer">
							<input type="range" min="10" max="500" step="5" value="30" class="slider" id="minDistInput">
							<span>Minimum Distance: </span><span id="minDistValue">30</span> <span>meters</span>
						</div>
						<br>
						<div class="slideContainer">
							<input type="range" min="100" max="5000" step="5" value="300" class="slider" id="maxDistInput">
							<span>Maximum Distance: </span><span id="maxDistValue">300</span> <span>meters</span>
						</div>

					</div>


					<button style="box-shadow: none; margin: 1rem 0 0 0; padding: 0; font-size: .75em;" id="enableInfoLoss">Enable Cluster Metrics</button> <span class="icon fa-info-circle tooltip"><span class="tooltiptext">Provides additional tools to see how much the masking process changed the data, which may help when judging what masking distance to use. Uses DBSCAN to identify points that form clusters, and notes the number of clusters identified before and after masking (ideally these values are the same). Meant for exploratory purposes only.</span></span>



					<div style="display: none;" id="infoDiv">

						<div class="slideContainer">
							<input type="range" min="50" max="10000" step="50" value="500" class="slider" id="bandwidth">
							<span>Maximum Cluster Distance: <span id="sliderValue"></span> meters</span> <span class="icon fa-info-circle tooltip"><span class="tooltiptext">This value adjusts the distance used by the DBSCAN algorithm to detect clusters. DBSCAN is both complicated and <i>very</i> sensitive to this distance value, so don't use this to try and detect real, meaningful clusters in your data. Instead, play around with the value, see how it affects cluster detection until you find a value that you think looks reasonable, and use it for <i>exploring</i> how masking changes the distribution of your data and some of the <i>potential</i> clusters within it.</span></span>
						</div>
						<br>
						<strong id="clusterReport">Number of Clusters Detected</strong> <span class="icon fa-info-circle tooltip"><span class="tooltiptext">Points that form clusters are represented in bold on the map. Ideally the number and location of clusters before and after masking are similar.</span></span><br>
						<span id="beforeMasking">Before Masking: </span><br>
						<span id="afterMasking">After Masking: </span><br>
						<span id="addLoss">Clusters Lost or Added: </span><br>
						<br>


					</div>
					<br>
					<div id="privacyRatingDiv" style="display: none;">
						<strong>Privacy Rating: </strong><strong id="privacyRating"></strong> <span class="icon fa-info-circle tooltip"><span class="tooltiptext">This represents the percentage of masked points that are closer to any sensitive point other than their original/parent/unmasked point. While this is a crude measure of privacy, higher ratings suggest a lower level of disclosure risk. A rating of 100 does not guarantee perfect privacy. Based on Spruill's Measure and inverted for clarity, as described <a href="https://onlinelibrary.wiley.com/doi/abs/10.1002/%28SICI%291097-0258%2819990315%2918%3A5%3C497%3A%3AAID-SIM45%3E3.0.CO%3B2-%23" style="color: #a00808;" target="_blank">here</a>.</span></span>
					</div>

					<div id="centerMoveDiv" style="display:none;">
						<strong id="centerMove">Center Displacement Distance: </strong> <span class="icon fa-info-circle tooltip"><span class="tooltiptext">This represents how far the center of the point pattern moved due to masking. If you're unsure what a 'mean center' is, <a href="https://pro.arcgis.com/en/pro-app/tool-reference/spatial-statistics/h-how-mean-center-spatial-statistics-works.htm"style="color: #a00808;" target="_blank">click here</a> for a good explanation from ESRI.</span></span>
					</div>

					<button style="margin: 1rem 0 0 0; width: 100%;" id="display">Display Data</button>

					<button style="margin: 0.5rem 0 .5rem 0; width: 100%;" id="mask">Mask My XYZ!</button><br>

					<div id="map" style="height:50vh;"></div>

					<div id="citationLoader"><a href="#citation"><button style="margin: 1rem 0 0 0; width: 100%;" id="downloadMasked">Download Masked Data</button></a></div>

					<button style="margin: 0.5rem 0 .5rem 0; width: 100%;" id="clear">Clear All</button>

					<h1>Neighborhood Suitability Analysis in Utah</h1>
						<p>
							Suitability analysis allows a user to explore the appropriateness of an area based on a specific set of criteria.
							This application allows the user to select the individual criteria on which to assess and assign a weight to that
							criteria by moving the respective slider bar. When you move a slider bar to the right, the areas on the map that are
							higher in this criteria will be highlighted (i.e., darker hexagons indicate areas of higher suitability).
							Conversely, this map can also be used to explore areas that are less suitable.
						</p>
						<div id="container">
							<div id="controlContainer">
							<label for="childcareWeight">Childcare</label>
							<input id="childcareWeight" type="range" min="0" max="1" step="any" value="0" />
							<label for="hospitalWeight">Hospitals</label>
							<input id="hospitalWeight" type="range" min="0" max="1" step="any" value="0" />
							<label for="groceryWeight">Grocery and Food</label>
							<input id="groceryWeight" type="range" min="0" max="1" step="any" value="0" />
							<label for="libraryWeight">Public Libraries</label>
							<input id="libraryWeight" type="range" min="0" max="1" step="any" value="0" />
							<label for="charterschoolsWeight">Charter Schools</label>
							<input id="charterschoolsWeight" type="range" min="0" max="1" step="any" value="0" />
							<label for="higheredWeight">Colleges and Universities</label>
							<input id="higheredWeight" type="range" min="0" max="1" step="any" value="0" />
							<label for="utarailstationlayerWeight">UTA Light Rail Stations</label>
							<input id="utarailstationlayerWeight" type="range" min="0" max="1" step="any" value="0" />
							<label for="utabusstopslayerWeight">UTA Bus Stops</label>
							<input id="utabusstopslayerWeight" type="range" min="0" max="1" step="any" value="0" />
							<label for="commcentersWeight">Community Centers</label>
							<input id="commcentersWeight" type="range" min="0" max="1" step="any" value="0" />
							<label for="localparksWeight">Local Parks</label>
							<input id="localparksWeight" type="range" min="0" max="1" step="any" value="0" />
							</div>
							<div id="mapContainer" style="display: none;"></div>
						</div>
						<input id="clickMe" type="button" value="Show Map" onclick="displayMap();" />

						<p>This map was created using <a href="https://wiki.openstreetmap.org/wiki/API" rel="nofollow">OSM</a> and the <a
							href="https://github.com/uber/h3">Uber H3 Hexagonal Geospatial Indexing System</a>, <a
							href="https://h3geo.org/docs/core-library/restable" rel="nofollow">resolution 8</a>.</p>

						<p>
							<strong>Data Sources</strong><br>
							Childcare - <a href="https://data.wfrc.org/datasets/utah-child-care-centers" rel="nofollow">WFRC Child Care Centers
							GIS layer</a><br>
							Hospitals - <a href="https://data.wfrc.org/datasets/utah-hospitals" rel="nofollow">WFRC Hospitals GIS layer</a><br>
							Grocery and Food - <a href="https://data.wfrc.org/datasets/utah-grocery-and-food-stores-uda" rel="nofollow">WFRC
							Grocery and Food Stores GIS layer</a><br>
							Public Libraries - <a href="https://opendata.gis.utah.gov/datasets/utah-public-libraries/" rel="nofollow">UGRC
							Public Libraries GIS layer</a><br>
							Charter Schools - <a href="https://opendata.gis.utah.gov/datasets/utah-schools-prek-to-12" rel="nofollow">UGRC
							Schools GIS layer</a><br>
							Colleges and Universities - <a href="https://opendata.gis.utah.gov/datasets/utah-schools-higher-education/"
							rel="nofollow">UGRC Colleges and Universities GIS layer</a><br>
							UTA Light Rail Stations - <a href="https://opendata.gis.utah.gov/datasets/utah-uta-light-rail-stations/"
							rel="nofollow">UTA Light Rail Stations GIS layer</a><br>
							UTA Bus Stops - <a href="https://opendata.gis.utah.gov/datasets/utah-uta-bus-stops-wasatch-front/"
							rel="nofollow">UTA Bus Stops GIS layer</a><br>
							Community Centers - <a href="https://data.wfrc.org/datasets/community-centers/" rel="nofollow">WFRC Community
							Centers GIS layer</a><br>
							Local Parks - <a href="https://opendata.gis.utah.gov/datasets/utah-parks-local" rel="nofollow">UGRC Local Parks GIS
							layer</a>
						</p>

						Built by <a href="https://gis.utah.gov">UGRC</a>

					<script>
						//Set a bunch of variables based on user input
						var bandwidth = document.getElementById("bandwidth");
						var output = document.getElementById("sliderValue");
						var minDistInput = document.getElementById("minDistInput");
						var minDistValue = document.getElementById("minDistValue");
						var maxDistInput = document.getElementById("maxDistInput");
						var maxDistValue = document.getElementById("maxDistValue");

						//This section just edits the values so that the sliders work
						clustersEnabled = false;
						output.innerHTML = bandwidth.value;
						bandwidth.oninput = function() {
						output.innerHTML = this.value;
						}
						minDistInput.oninput = function() {
						minDistValue.innerHTML = this.value;
						}
						maxDistInput.oninput = function() {
						maxDistValue.innerHTML = this.value;
						}

						//Enables the cluster detection tools
						$("#enableInfoLoss").click(function(){
							clustersEnabled = true;
							$("#infoDiv").show();
							$(".slideContainer").show();
						});

						//The Map!
						var map = new ol.Map({
							target: 'map',
							layers: [
							new ol.layer.Tile({
								source: new ol.source.XYZ({
									url:'https://basemaps.cartocdn.com/light_nolabels/{z}/{x}/{y}.png',
								})
							})
							],
							view: new ol.View({
							center: ol.proj.fromLonLat([-100, 45]),
							zoom: 3,
							maxZoom: 13
							})
						});

						//Download button, defines the options for shpwrite and then triggers the download. Also loads the citation page upon click
						$("#downloadMasked").on("click", function () {
							$("#citation").load();
							var options = {
								folder: 'MaskedData',
								types: {
									point: 'MaskedPoints',
								}
							}
							shpwrite.download(masked.reprojected, options);
						});

						//Trigger functions based on user input from buttons
						$("#sensitiveInput").change(function(){loadShapeFile("sensitiveInput", "sensitiveTag", "sensitive")});
						$("#boundaryInput").change(function(){loadShapeFile("boundaryInput", "boundaryTag", "boundary")});
						$("#display").click(function(){toMap(sensitive.data, sensitive.style), toMap(boundary.data, boundary.style)});
						$("#mask").click(function(){xyz.displace("sensitive", "masked"), toMap(sensitive.data, sensitive.style), toMap(masked.data, masked.style), toMap(sensitiveClusters.cluster, sensitiveClusters.style), toMap(maskedClusters.cluster, maskedClusters.style)});
						$("#clear").click(function(){location.reload()});
					</script>
				</article>
				<article id="citation">
					<h2>Important Information:</h2>
					<ul>
					<li>MaskMy.XYZ isn't a silver bullet for privacy protection. It makes donut geomasking easy, but you still need to use appropriate masking distances for your dataset. Even 5km masking distances aren't enough if there's no one else living within 5km of a given point.</li>
					<li>Remember that MaskMy.XYZ preserves all attribute data from your original shapefile. Since attribute data often also contains sensitive information, make sure to delete or anonymize that as well before you share your data.</li>
					<li>Never reveal your masking distances to anyone, as this can weaken the effectiveness of the mask. Instead, simply state in your publication that the data was masked. Here's a standard line of text you can feel free to copy or modify and include in your publication:</li>

						<li style="margin-left: 1.5rem; margin-top: .5rem;"><i>"Sensitive spatial data was geographically masked using MaskMy.XYZ prior to publication to protect privacy, and therefore point locations on the map do not represent actual locations. Specific masking parameters have also been withheld to protect the integrity of the mask."</i></li>


					</ul>
					<h2>Find MaskMy.XYZ useful?</h2>
					<p>Help spread the word by citing it in your research or sharing it on social media. Just remember to keep your actual masking distances a secret!</p>
					<p style="margin-bottom: 0;"><strong>APA:</strong> Swanlund, D., Schuurman, N., & Brussoni, M. (2019). MaskMy.XYZ: An Easy-To-Use Tool for Protecting Geoprivacy Using Geographic Masks. Transactions in GIS. https://doi.org/10.1111/tgis.12606</p>
					<p style="margin-bottom: 0;"><strong>Chicago (Full Note):</strong>Swanlund, David, Nadine Schuurman, and Mariana Brussoni. "MaskMy.XYZ: An Easy-To-Use Tool for Protecting Geoprivacy Using Geographic Masks." Transactions in GIS, 2019. https://doi.org/10.1111/tgis.12606.</p>
					<p><strong>MLA:</strong> Swanlund, David, et al. "MaskMy.XYZ: An Easy-To-Use Tool for Protecting Geoprivacy Using Geographic Masks." Transactions in GIS, 2019, doi:10.1111/tgis.12606.</p>
					<a href="#dm"><button style="width:100%">Back</button></a>
				</article>


				<article id="disclaimer">
					<h2 id="disclaimer">Disclaimer</h2>
					<p>MaskMy.XYZ is a tool that 1) offers general advice about geographic masking, and 2) makes certain geographic masks easier to use, but it is not a silver bullet for privacy protection or data anonymization. Geographic masking requires careful consideration and intimate knowledge of the data that is being masked to be effective. For instance, displacing a location in a densely populated city by 200 meters may provide very strong privacy protection, but in a rural environment it may provide little to no privacy at all. In other words, following the advice provided by MaskMy.XYZ and using its masking tools to anonymize your spatial data does not guarantee that your data is adeqautely protected. There are simply too many factors involved in privacy protection for any geographic masking method, tool, or service to provide any such guarantee. Frankly, to do so would be dishonest. Therefore, MaskMy.XYZ is provided 'as is', without warranty of any kind, expressed or implied. The project uses an <a href="https://tldrlegal.com/license/mit-license">MIT license</a>, which is described below.</p>
					<hr>
					<h3>MIT License</h3>
					<p>Copyright (c) 2019, David Swanlund</p>

					<p>Permission is hereby granted, free of charge, to any person obtaining a copy of this software and associated documentation files (the "Software"), to deal in the Software without restriction, including without limitation the rights to use, copy, modify, merge, publish, distribute, sublicense, and/or sell copies of the Software, and to permit persons to whom the Software is furnished to do so, subject to the following conditions:</p>

					<p>The above copyright notice and this permission notice shall be included in all copies or substantial portions of the Software.</p>

					<p>THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE SOFTWARE.</p>

				</article>

				<article id="privacy">
					<h2 id="privacy">Privacy Policy</h2>
					<p>MaskMy.XYZ uses Matomo Analytics to track usage. Matomo is an open-source, privacy focused analytics system that anonymizes user data. This data is stored in Canada, never sold, and is only used to see how much the tool is being used. More information on what data Matomo can collect can be found [here](https://matomo.org/faq/general/faq_18254/). Note that the site is hosted on Github pages, which has its own [privacy policy](https://docs.github.com/en/github/site-policy/github-privacy-statement).</p>

					<p>This policy was last updated in November 2021, and may change at any time.</p>
				</article>


			</div>

		<!-- Footer -->
			<footer id="footer">
				<p class="copyright">MaskMy.XYZ by <a href="https://twitter.com/The_Tin_Hat" target="_blank">David Swanlund</a> | Modified website based on: <a href="https://html5up.net">HTML5 UP</a> | <a href="#privacy">Privacy Policy</a> | <a href="https://github.com/TheTinHat/MaskMyXYZ">Github</a></p>
			</footer>

		</div>

		<!-- Background -->
		<div id="bg"></div>

		<!-- Tags for injecting geoJSON data -->
		<script id="sensitiveTag"></script>
		<script id="boundaryTag"></script>

		<script type="module">
		import geojson2h3 from "https://cdn.skypack.dev/geojson2h3@1.0.1";

		// Config
		const config = {
			lng: -111.904,
			lat: 40.719,
			zoom: 9,
			fillOpacity: 0.6,
			colorScale: ["#ffffD9", "#50BAC3", "#1A468A"],
			h3Resolution: 8
		};

		// Utilities
		function normalizeLayer(layer, baseAtZero = false) {
			const hexagons = Object.keys(layer);
			// Pass one, get max
			const max = hexagons.reduce(
				(max, hex) => Math.max(max, layer[hex]),
				-Infinity
			);
			const min = baseAtZero
				? hexagons.reduce((min, hex) => Math.min(min, layer[hex]), Infinity)
				: 0;
			// Pass two, normalize
			hexagons.forEach((hex) => {
				layer[hex] = (layer[hex] - min) / (max - min);
			});
			return layer;
		}

		function getSliderValue(id) {
			const input = document.getElementById(id);
			const value = parseFloat(input.value);
			console.log(`${id}: ${value}`);

			return value;
		}

		// Transform a kilometer measurement to a k-ring radius
		function kmToRadius(km, resolution) {
			return Math.floor(km / h3.edgeLength(resolution, h3.UNITS.km));
		}

		function bufferPointsLinear(geojson, radius, h3Resolution) {
			const layer = {};
			geojson.features.forEach((feature) => {
				const [lng, lat] = feature.geometry.coordinates;
				const stationIndex = h3.geoToH3(
				lat,
				lng,
				h3Resolution
				);
				// add surrounding multiple surrounding rings, with less weight in each
				const rings = h3.kRingDistances(stationIndex, radius);
				const step = 1 / (radius + 1);
				rings.forEach((ring, distance) => {
				ring.forEach((h3Index) => {
					layer[h3Index] = (layer[h3Index] || 0) + 1 - distance * step;
				});
				});
		});

		return normalizeLayer(layer);
		}

		function interpolateColor(value, stops, colors) {
			const index = stops.findIndex((stop) => value <= stop);
			if (index < 0) {
				return colors[colors.length - 1];
			}
			if (index === 0) {
				return colors[0];
			}
			const startColor = ol.color.asArray(colors[index - 1]);
			const endColor = ol.color.asArray(colors[index]);
			const startStop = stops[index - 1];
			const endStop = stops[index];
			const result = [0, 0, 0, 0]
			for (let i = 0; i < 4; ++i) {
				result[i] = startColor[i] + ((endColor[i] - startColor[i]) * (value - startStop) / (endStop - startStop))
			}
			return ol.color.asString(result);
		}

		let hospitals;
		let childcare;
		let grocery;
		let libraries;
		let highered;
		let utarailstations;
		let commcenters;

		async function getRawData() {
		hospitals = await d3.json(
			"https://opendata.arcgis.com/datasets/39aba645ea9847668df557d1c8dbd666_0.geojson"
		);
		childcare = await d3.json(
			"https://opendata.arcgis.com/datasets/64dd5af56d63483d8bb6841879bb9702_0.geojson"
		);
		grocery = await d3.json(
			"https://opendata.arcgis.com/datasets/81b4eeea6c6c426aa9b165df6eb56870_0.geojson"
		);
		libraries = await d3.json(
			"https://opendata.arcgis.com/datasets/f6cf0c8ef65344b6a6e5ebeaa108f549_0.geojson"
		);
		highered = await d3.json(
			"https://opendata.arcgis.com/datasets/731644a217f445e5a638f9a84a7ada93_0.geojson"
		);
		utarailstations = await d3.json(
			"https://opendata.arcgis.com/datasets/bb8f7bc8871b4a7594bcc037631073e7_0.geojson"
		);
		commcenters = await d3.json(
			"https://opendata.arcgis.com/datasets/25dba734a2f34059bf58143834284d0f_0.geojson"
		);
		}

		async function getData() {
		console.log('getData');

		const h3Resolution = config.h3Resolution;
		// Data Layers
		const hospitallayer = normalizeLayer(
			bufferPointsLinear(hospitals, kmToRadius(1, h3Resolution), h3Resolution)
		);
		const childcarelayer = normalizeLayer(
			bufferPointsLinear(childcare, kmToRadius(1, h3Resolution), h3Resolution)
		);
		const grocerylayer = normalizeLayer(
			bufferPointsLinear(grocery, kmToRadius(1, h3Resolution), h3Resolution)
		);
		const librarylayer = normalizeLayer(
			bufferPointsLinear(libraries, kmToRadius(1, h3Resolution), h3Resolution)
		);
		const higheredlayer = normalizeLayer(
			bufferPointsLinear(highered, kmToRadius(1, h3Resolution), h3Resolution)
		);
		const utarailstationlayer = normalizeLayer(
			bufferPointsLinear(utarailstations, kmToRadius(1, h3Resolution), h3Resolution)
		);
		const commcenterslayer = normalizeLayer(
			bufferPointsLinear(commcenters, kmToRadius(1, h3Resolution), h3Resolution)
		);
		const localparkslayer = normalizeLayer(
			bufferPointsLinear(commcenters, kmToRadius(1, h3Resolution), h3Resolution)
		);


		// Combining Layers
		const mapLayers = [
			{ hexagons: hospitallayer, weight: getSliderValue("hospitalWeight") },
			{
			hexagons: childcarelayer,
			weight: getSliderValue("childcareWeight"),
			},
			{ hexagons: grocerylayer, weight: getSliderValue("groceryWeight") },
			{ hexagons: librarylayer, weight: getSliderValue("libraryWeight") },
			{ hexagons: higheredlayer, weight: getSliderValue("higheredWeight") },
			{
			hexagons: commcenterslayer,
			weight: getSliderValue("commcentersWeight"),
			},
			{
			hexagons: utarailstationlayer,
			weight: getSliderValue("utarailstationlayerWeight"),
			},
			{
			hexagons: localparkslayer,
			weight: getSliderValue("localparksWeight"),
			},
		];

		const combinedLayers = {};
		mapLayers.forEach(({ hexagons, weight }) => {
			Object.keys(hexagons).forEach((hex) => {
			combinedLayers[hex] =
				(combinedLayers[hex] || 0) + hexagons[hex] * weight;
			});
		});

		return combinedLayers;
		}

		// Map Rendering
		function init() {
		console.log("init");

		const outlineColor = 'rgba(0,0,0,0)';
		const style = new ol.style.Style({
			stroke: new ol.style.Stroke({
			color: outlineColor,
			width: 1,
			}),
			fill: new ol.style.Fill(),
		});

		const vectorLayer = new ol.layer.Vector({
			"visible":false,
			style: (feature) => {
			const value = feature.get('value');
			style.getFill().setColor(interpolateColor(value, [0, 0.5, 1], config.colorScale))
			return style;
			},
			opacity: config.fillOpacity,
		});

		const map = new ol.Map({
			target: document.getElementById("mapContainer"),
			view: new ol.View({
			center: ol.proj.fromLonLat([config.lng, config.lat]),
			zoom: config.zoom + 1,
			}),
			layers: [
			new ol.layer.Tile({
				source: new ol.source.OSM(),
			}),
			vectorLayer,
			]
		});
		map.once("rendercomplete", async () => {
			console.log("map load");

			await getRawData();

			refreshMap(vectorLayer);

			const inputs = document.getElementsByTagName("input");
			for (let input of inputs) {
			console.log('hello')
			input.addEventListener("change", () => {
				refreshMap(vectorLayer);
				vectorLayer.setVisible(true); 
			});
			}
		});
		}

		async function refreshMap(vectorLayer) {
		console.log('refreshMap');

		const combinedLayers = await getData();

		renderHexes(vectorLayer, combinedLayers);
		}

		function renderHexes(vectorLayer, hexagons) {
		console.log("renderHexes");

		// Transform the current hexagon map into a GeoJSON object
		const geojson = geojson2h3.h3SetToFeatureCollection(
			Object.keys(hexagons),
			(hex) => ({ value: hexagons[hex] })
		);

		const features = new ol.format.GeoJSON().readFeatures(geojson, {
			featureProjection: 'EPSG:3857'
		});

		const vectorSource = new ol.source.Vector({ features: features });
		vectorLayer.setSource(vectorSource);
		}

		init();
	</script>


	</body>

</html>
<!--
	Dimension by HTML5 UP
	html5up.net | @ajlkn
	Free for personal and commercial use under the CCA 3.0 license (html5up.net/license)
-->
